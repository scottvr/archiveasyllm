{% extends 'base.html' %}

{% block title %}{{ project.name }} - ArchivistLLM{% endblock %}

{% block content %}
<div class="container-lg">
  <div class="row mb-4">
    <div class="col">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1>{{ project.name }}</h1>
          <p class="text-muted">{{ project.description }}</p>
        </div>
        <div>
          <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#projectSettingsModal">
            <i class="bi bi-gear"></i> Settings
          </button>
        </div>
      </div>
    </div>
  </div>
  
  {% if project.codebase_path %}
  <div class="row mb-4">
    <div class="col">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Codebase</h5>
          <button class="btn btn-sm btn-outline-primary" id="updateCodebaseBtn">
            <i class="bi bi-arrow-repeat"></i> Update
          </button>
        </div>
        <div class="card-body">
          <p><strong>Path:</strong> {{ project.codebase_path }}</p>
          
          {% if project.codebase_stats %}
          <div class="row">
            <div class="col-md-6">
              <h6>Analysis Statistics</h6>
              <ul>
                <li>Files processed: {{ project.codebase_stats.files_processed }}</li>
                <li>Entities extracted: {{ project.codebase_stats.entities_extracted }}</li>
                <li>Relationships: {{ project.codebase_stats.relationships_extracted }}</li>
                <li>Decisions identified: {{ project.codebase_stats.decisions_extracted }}</li>
                <li>Patterns identified: {{ project.codebase_stats.patterns_extracted }}</li>
              </ul>
            </div>
            <div class="col-md-6">
              <h6>Language Breakdown</h6>
              {% if project.codebase_stats.languages %}
              <ul>
                {% for lang, count in project.codebase_stats.languages.items() %}
                <li>{{ lang }}: {{ count }} files</li>
                {% endfor %}
              </ul>
              {% else %}
              <p>No language data available.</p>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  
  <div class="row mb-4">
    <div class="col">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Chats</h5>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newChatModal">
            <i class="bi bi-plus"></i> New Chat
          </button>
        </div>
        <div class="card-body">
          {% if chats %}
          <div class="row">
            {% for chat in chats %}
            <div class="col-md-4 mb-3">
              <div class="card chat-card h-100" onclick="window.location.href='/chat/{{ chat.id }}'">
                <div class="card-body">
                  <h5 class="card-title">{{ chat.name }}</h5>
                  <p class="card-text text-muted">
                    {{ chat.message_count }} messages
                    <br>
                    <small>Last updated: {{ chat.updated_at.strftime('%Y-%m-%d %H:%M') }}</small>
                  </p>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-center py-4">
            <i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
            <p class="mt-3">No chats yet. Start a new chat to begin.</p>
            <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#newChatModal">
              <i class="bi bi-plus"></i> New Chat
            </button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  {% if not project.codebase_path %}
  <div class="row mb-4">
    <div class="col">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Add Codebase</h5>
        </div>
        <div class="card-body">
          <p>Connect this project to an existing codebase to extract knowledge and maintain consistency.</p>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCodebaseModal">
            <i class="bi bi-folder-plus"></i> Add Codebase
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  
  <div class="row mb-4">
    <div class="col">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Knowledge Graph</h5>
        </div>
        <div class="card-body">
          <ul class="nav nav-tabs" id="knowledgeTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="decisions-tab" data-bs-toggle="tab" data-bs-target="#decisions" type="button" role="tab">
                Decisions
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="patterns-tab" data-bs-toggle="tab" data-bs-target="#patterns" type="button" role="tab">
                Patterns
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="entities-tab" data-bs-toggle="tab" data-bs-target="#entities" type="button" role="tab">
                Entities
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="relationships-tab" data-bs-toggle="tab" data-bs-target="#relationships" type="button" role="tab">
                Relationships
              </button>
            </li>
          </ul>
          
          <div class="tab-content mt-3" id="knowledgeTabContent">
            <!-- Decisions Tab -->
            <div class="tab-pane fade show active" id="decisions" role="tabpanel" aria-labelledby="decisions-tab">
              <div id="decisionsLoading" class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
              <div id="decisionsContent" style="display: none;">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Title</th>
                        <th>Reasoning</th>
                        <th>Alternatives</th>
                      </tr>
                    </thead>
                    <tbody id="decisionsTable">
                    </tbody>
                  </table>
                </div>
                <div id="noDecisions" class="text-center py-3" style="display: none;">
                  <p>No architectural decisions found.</p>
                </div>
              </div>
            </div>
            
            <!-- Patterns Tab -->
            <div class="tab-pane fade" id="patterns" role="tabpanel" aria-labelledby="patterns-tab">
              <div id="patternsLoading" class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
              <div id="patternsContent" style="display: none;">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Examples</th>
                      </tr>
                    </thead>
                    <tbody id="patternsTable">
                    </tbody>
                  </table>
                </div>
                <div id="noPatterns" class="text-center py-3" style="display: none;">
                  <p>No design patterns found.</p>
                </div>
              </div>
            </div>
            
            <!-- Entities Tab -->
            <div class="tab-pane fade" id="entities" role="tabpanel" aria-labelledby="entities-tab">
              <div id="entitiesLoading" class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
              <div id="entitiesContent" style="display: none;">
                <div class="mb-3">
                  <div class="input-group">
                    <input type="text" class="form-control" id="entitySearch" placeholder="Search entities...">
                    <button class="btn btn-outline-secondary" type="button" id="entitySearchBtn">
                      <i class="bi bi-search"></i>
                    </button>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>File</th>
                      </tr>
                    </thead>
                    <tbody id="entitiesTable">
                    </tbody>
                  </table>
                </div>
                <div id="noEntities" class="text-center py-3" style="display: none;">
                  <p>No entities found.</p>
                </div>
              </div>
            </div>
            
            <!-- Relationships Tab -->
            <div class="tab-pane fade" id="relationships" role="tabpanel" aria-labelledby="relationships-tab">
              <div id="relationshipsLoading" class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
              <div id="relationshipsContent" style="display: none;">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>From</th>
                        <th>Relationship</th>
                        <th>To</th>
                      </tr>
                    </thead>
                    <tbody id="relationshipsTable">
                    </tbody>
                  </table>
                </div>
                <div id="noRelationships" class="text-center py-3" style="display: none;">
                  <p>No relationships found.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Chat Modal -->
<div class="modal fade" id="newChatModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New Chat</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="newChatForm">
          <div class="mb-3">
            <label for="chatName" class="form-label">Chat Name</label>
            <input type="text" class="form-control" id="chatName" required>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="createChatBtn">Create Chat</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Codebase Modal -->
<div class="modal fade" id="addCodebaseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Codebase</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addCodebaseForm">
          <div class="mb-3">
            <label for="codebasePath" class="form-label">Codebase Path</label>
            <input type="text" class="form-control" id="codebasePath" placeholder="/path/to/codebase" required>
            <div class="form-text">
              Enter the absolute path to the codebase on the server.
            </div>
          </div>
          <div class="mb-3">
            <label for="excludedDirs" class="form-label">Excluded Directories</label>
            <input type="text" class="form-control" id="excludedDirs" value="node_modules,venv,.venv,env,__pycache__,.git,dist,build">
            <div class="form-text">
              Comma-separated list of directories to exclude from analysis.
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="analyzeCodebaseBtn">
          <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          Analyze Codebase
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Project Settings Modal -->
<div class="modal fade" id="projectSettingsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Project Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="projectSettingsForm">
          <div class="mb-3">
            <label for="projectName" class="form-label">Project Name</label>
            <input type="text" class="form-control" id="projectName" value="{{ project.name }}" required>
          </div>
          <div class="mb-3">
            <label for="projectDescription" class="form-label">Description</label>
            <textarea class="form-control" id="projectDescription" rows="3">{{ project.description }}</textarea>
          </div>
          
          <h6 class="mt-4">Memory Settings</h6>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="extractPatterns" checked>
            <label class="form-check-label" for="extractPatterns">Extract design patterns</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="extractDecisions" checked>
            <label class="form-check-label" for="extractDecisions">Extract architectural decisions</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="consistencyChecking" checked>
            <label class="form-check-label" for="consistencyChecking">Enable consistency checking</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveProjectSettingsBtn">Save Settings</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // New Chat
    const createChatBtn = document.getElementById('createChatBtn');
    createChatBtn.addEventListener('click', async function() {
      const chatName = document.getElementById('chatName').value.trim();
      
      if (!chatName) {
        alert('Chat name is required');
        return;
      }
      
      try {
        const response = await fetch('/chat/new', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            'project_id': '{{ project.id }}',
            'name': chatName
          })
        });
        
        if (!response.ok) {
          throw new Error('Failed to create chat');
        }
        
        const data = await response.json();
        
        // Redirect to the new chat
        window.location.href = `/chat/${data.id}`;
        
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while creating the chat');
      }
    });
    
    // Add Codebase
    const analyzeCodebaseBtn = document.getElementById('analyzeCodebaseBtn');
    if (analyzeCodebaseBtn) {
      analyzeCodebaseBtn.addEventListener('click', async function() {
        const codebasePath = document.getElementById('codebasePath').value.trim();
        const excludedDirs = document.getElementById('excludedDirs').value.trim();
        
        if (!codebasePath) {
          alert('Codebase path is required');
          return;
        }
        
        // Show loading state
        const spinner = analyzeCodebaseBtn.querySelector('.spinner-border');
        spinner.classList.remove('d-none');
        analyzeCodebaseBtn.disabled = true;
        
        try {
          const response = await fetch(`/api/project/{{ project.id }}/analyze-codebase`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              'codebase_path': codebasePath,
              'excluded_dirs': excludedDirs
            })
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to analyze codebase');
          }
          
          const data = await response.json();
          
          // Close modal and reload page
          const modal = bootstrap.Modal.getInstance(document.getElementById('addCodebaseModal'));
          modal.hide();
          
          // Show success message
          alert(`Codebase analysis complete: ${data.message}`);
          
          // Reload page to show updated data
          window.location.reload();
          
        } catch (error) {
          console.error('Error:', error);
          alert(`An error occurred: ${error.message}`);
        } finally {
          // Reset loading state
          spinner.classList.add('d-none');
          analyzeCodebaseBtn.disabled = false;
        }
      });
    }
    
    // Update Codebase
    const updateCodebaseBtn = document.getElementById('updateCodebaseBtn');
    if (updateCodebaseBtn) {
      updateCodebaseBtn.addEventListener('click', async function() {
        if (!confirm('This will re-analyze the codebase. Continue?')) {
          return;
        }
        
        // Show loading state
        updateCodebaseBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Updating...';
        updateCodebaseBtn.disabled = true;
        
        try {
          const response = await fetch(`/api/project/{{ project.id }}/analyze-codebase`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to update codebase');
          }
          
          const data = await response.json();
          
          // Show success message
          alert(`Codebase update complete: ${data.message}`);
          
          // Reload page to show updated data
          window.location.reload();
          
        } catch (error) {
          console.error('Error:', error);
          alert(`An error occurred: ${error.message}`);
        } finally {
          // Reset button
          updateCodebaseBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Update';
          updateCodebaseBtn.disabled = false;
        }
      });
    }
    
    // Knowledge Graph Tabs
    const knowledgeTabs = document.querySelectorAll('button[data-bs-toggle="tab"]');
    knowledgeTabs.forEach(tab => {
      tab.addEventListener('shown.bs.tab', function(event) {
        const targetId = event.target.getAttribute('data-bs-target').substring(1);
        loadTabContent(targetId);
      });
    });
    
    // Load initial tab content
    loadTabContent('decisions');
    
    // Load tab content function
    function loadTabContent(tabId) {
      const loadingEl = document.getElementById(`${tabId}Loading`);
      const contentEl = document.getElementById(`${tabId}Content`);
      const noDataEl = document.getElementById(`no${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`);
      const tableEl = document.getElementById(`${tabId}Table`);
      
      // Show loading, hide content
      if (loadingEl) loadingEl.style.display = 'block';
      if (contentEl) contentEl.style.display = 'none';
      if (noDataEl) noDataEl.style.display = 'none';
      
      // Fetch data based on tab
      fetch(`/api/project/{{ project.id }}/knowledge/${tabId}`)
        .then(response => response.json())
        .then(data => {
          // Hide loading
          if (loadingEl) loadingEl.style.display = 'none';
          
          if (data.length === 0) {
            // Show no data message
            if (noDataEl) noDataEl.style.display = 'block';
          } else {
            // Show content and populate table
            if (contentEl) contentEl.style.display = 'block';
            
            if (tableEl) {
              tableEl.innerHTML = '';
              
              // Populate table based on tab
              if (tabId === 'decisions') {
                data.forEach(decision => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                    <td>${decision.title}</td>
                    <td>${decision.reasoning}</td>
                    <td>${decision.alternatives.join(', ')}</td>
                  `;
                  tableEl.appendChild(row);
                });
              } else if (tabId === 'patterns') {
                data.forEach(pattern => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                    <td>${pattern.name}</td>
                    <td>${pattern.description}</td>
                    <td>${pattern.examples.join('<br>')}</td>
                  `;
                  tableEl.appendChild(row);
                });
              } else if (tabId === 'entities') {
                data.forEach(entity => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                    <td>${entity.name}</td>
                    <td>${entity.type}</td>
                    <td>${entity.file || 'N/A'}</td>
                  `;
                  tableEl.appendChild(row);
                });
              } else if (tabId === 'relationships') {
                data.forEach(rel => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                    <td>${rel.from_name}</td>
                    <td><strong>${rel.type}</strong></td>
                    <td>${rel.to_name}</td>
                  `;
                  tableEl.appendChild(row);
                });
              }
            }
          }
        })
        .catch(error => {
          console.error('Error fetching data:', error);
          // Hide loading, show error message
          if (loadingEl) loadingEl.style.display = 'none';
          if (contentEl) contentEl.style.display = 'block';
          if (tableEl) tableEl.innerHTML = `<tr><td colspan="3" class="text-center text-danger">Error loading data</td></tr>`;
        });
    }
    
    // Project Settings
    const saveProjectSettingsBtn = document.getElementById('saveProjectSettingsBtn');
    if (saveProjectSettingsBtn) {
      saveProjectSettingsBtn.addEventListener('click', async function() {
        const projectName = document.getElementById('projectName').value.trim();
        const projectDescription = document.getElementById('projectDescription').value.trim();
        const extractPatterns = document.getElementById('extractPatterns').checked;
        const extractDecisions = document.getElementById('extractDecisions').checked;
        const consistencyChecking = document.getElementById('consistencyChecking').checked;
        
        if (!projectName) {
          alert('Project name is required');
          return;
        }
        
        try {
          const response = await fetch(`/api/project/{{ project.id }}/settings`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              'name': projectName,
              'description': projectDescription,
              'settings': {
                'memory': {
                  'extract_patterns': extractPatterns,
                  'extract_decisions': extractDecisions,
                  'consistency_checking': consistencyChecking
                }
              }
            })
          });
          
          if (!response.ok) {
            throw new Error('Failed to save settings');
          }
          
          // Close modal and reload page
          const modal = bootstrap.Modal.getInstance(document.getElementById('projectSettingsModal'));
          modal.hide();
          
          // Reload page to show updated data
          window.location.reload();
          
        } catch (error) {
          console.error('Error:', error);
          alert('An error occurred while saving settings');
        }
      });
    }
  });
</script>
{% endblock %}
